<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HouseHunter - Find Your Dream Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=2000&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .score-positive {
            color: #10b981;
        }
        .score-negative {
            color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white drop-shadow-lg mb-2">üè† HouseHunter</h1>
            <p class="text-xl text-white drop-shadow-md">Make Smart House Decisions with Data-Driven Scoring</p>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Add House Form -->
            <div class="lg:col-span-1">
                <div class="glass-effect rounded-lg shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Add a House</h2>
                    <form id="addHouseForm" class="space-y-4">
                        <!-- Address -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Address *</label>
                            <input type="text" id="address" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="123 Main Street, City">
                        </div>

                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Notes</label>
                            <textarea id="notes" rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Any additional thoughts..."></textarea>
                        </div>

                        <!-- Features -->
                        <div class="border-t pt-4">
                            <h3 class="font-semibold text-gray-800 mb-3">Features</h3>
                            
                            <!-- Garage -->
                            <div class="space-y-2 mb-3">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="has_garage" class="rounded">
                                    <span class="text-sm">Has Garage <span class="text-green-600">(+1)</span></span>
                                </label>
                                <label class="flex items-center space-x-2 ml-6">
                                    <input type="checkbox" id="two_car_garage" class="rounded">
                                    <span class="text-sm">Two-Car Garage <span class="text-green-600">(+2)</span></span>
                                </label>
                            </div>

                            <!-- Bathrooms -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Bathrooms</label>
                                <select id="bathrooms" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="1">1 (+0)</option>
                                    <option value="2">2 (+1)</option>
                                    <option value="3">3+ (+2)</option>
                                </select>
                            </div>

                            <!-- Bedrooms -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Bedrooms</label>
                                <select id="bedrooms" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="1">1 (+0)</option>
                                    <option value="2">2 (+1)</option>
                                    <option value="3">3 (+2)</option>
                                    <option value="4">4+ (+4)</option>
                                </select>
                            </div>

                            <!-- Other Features -->
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="nice_backyard" class="rounded">
                                    <span class="text-sm">Nice Backyard <span class="text-green-600">(+2)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="curb_appeal" class="rounded">
                                    <span class="text-sm">Curb Appeal <span class="text-green-600">(+1)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="modern_appliances" class="rounded">
                                    <span class="text-sm">Modern Appliances <span class="text-green-600">(+1)</span></span>
                                </label>
                            </div>

                            <!-- HOA -->
                            <div class="mt-3 pt-3 border-t">
                                <label class="flex items-center space-x-2 mb-2">
                                    <input type="checkbox" id="has_hoa" class="rounded">
                                    <span class="text-sm">Has HOA <span class="text-red-600">(-1 base, -1 per $100/mo)</span></span>
                                </label>
                                <div id="hoaFeeContainer" class="ml-6 hidden">
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Monthly HOA Fee ($)</label>
                                    <input type="number" id="hoa_monthly_fee" min="0" value="0"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex gap-2 pt-4">
                            <button type="submit" 
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition font-semibold">
                                Add House
                            </button>
                            <button type="button" onclick="resetForm()"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">
                                Clear
                            </button>
                        </div>
                    </form>

                    <!-- Quick Actions -->
                    <div class="mt-6 pt-4 border-t space-y-2">
                        <button onclick="loadSeedData()" 
                            class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition text-sm">
                            Load Example Houses
                        </button>
                        <button onclick="clearAllHouses()" 
                            class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition text-sm">
                            Clear All Houses
                        </button>
                    </div>
                </div>
            </div>

            <!-- Houses List -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-lg shadow-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Your Houses</h2>
                        <span id="houseCount" class="text-sm text-gray-600">0 houses</span>
                    </div>
                    
                    <div id="housesContainer" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No houses added yet. Start by adding your first house!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // LocalStorage key for houses
        const STORAGE_KEY = 'househunter_houses';

        // Save houses to localStorage
        function saveToLocalStorage(houses) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(houses));
                console.log('Saved to localStorage:', houses.length, 'houses');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // Load houses from localStorage
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return [];
            }
        }

        // Sync houses from localStorage to server on startup
        async function syncFromLocalStorage() {
            const localHouses = loadFromLocalStorage();
            
            if (localHouses.length > 0) {
                console.log('Syncing', localHouses.length, 'houses from localStorage to server...');
                try {
                    const response = await fetch('/sync_houses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(localHouses)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Sync successful:', result.message);
                    }
                } catch (error) {
                    console.error('Error syncing from localStorage:', error);
                }
            }
        }

        // Form submission
        document.getElementById('addHouseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const houseData = {
                address: document.getElementById('address').value,
                notes: document.getElementById('notes').value || null,
                features: {
                    has_garage: document.getElementById('has_garage').checked,
                    two_car_garage: document.getElementById('two_car_garage').checked,
                    bathrooms: parseInt(document.getElementById('bathrooms').value),
                    bedrooms: parseInt(document.getElementById('bedrooms').value),
                    nice_backyard: document.getElementById('nice_backyard').checked,
                    curb_appeal: document.getElementById('curb_appeal').checked,
                    modern_appliances: document.getElementById('modern_appliances').checked,
                    has_hoa: document.getElementById('has_hoa').checked,
                    hoa_monthly_fee: parseInt(document.getElementById('hoa_monthly_fee').value) || 0
                }
            };

            try {
                const response = await fetch('/add_house', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(houseData)
                });

                if (response.ok) {
                    resetForm();
                    loadHouses();
                } else {
                    alert('Error adding house');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding house');
            }
        });

        // Load all houses
        async function loadHouses() {
            try {
                const response = await fetch('/houses');
                const houses = await response.json();
                
                // Save to localStorage whenever we load houses
                saveToLocalStorage(houses);
                
                const container = document.getElementById('housesContainer');
                const countEl = document.getElementById('houseCount');
                
                countEl.textContent = `${houses.length} house${houses.length !== 1 ? 's' : ''}`;
                
                if (houses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No houses added yet. Start by adding your first house!</p>';
                    return;
                }
                
                container.innerHTML = houses.map(house => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">${house.address}</h3>
                                ${house.notes ? `<p class="text-sm text-gray-600 mt-1">${house.notes}</p>` : ''}
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-3xl font-bold ${house.score >= 0 ? 'score-positive' : 'score-negative'}">
                                    ${house.score >= 0 ? '+' : ''}${house.score}
                                </div>
                                <div class="text-xs text-gray-500">points</div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${Object.entries(house.score_breakdown).map(([key, value]) => `
                                    <div class="text-gray-700">
                                        <span class="font-medium">${key.replace('_', ' ')}:</span> ${value}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200 flex gap-2">
                            <button onclick="viewDetails(${house.id})" 
                                class="flex-1 bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 transition">
                                View Details
                            </button>
                            <button onclick="deleteHouse(${house.id})" 
                                class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200 transition">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading houses:', error);
            }
        }

        // Delete house
        async function deleteHouse(id) {
            if (!confirm('Are you sure you want to delete this house?')) return;
            
            try {
                const response = await fetch(`/house/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadHouses();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // View details
        async function viewDetails(id) {
            try {
                const response = await fetch(`/score/${id}`);
                const data = await response.json();
                
                let details = `üìç ${data.address}\n\n`;
                details += `Total Score: ${data.score >= 0 ? '+' : ''}${data.score}\n\n`;
                details += 'Breakdown:\n';
                details += Object.entries(data.breakdown).map(([key, value]) => 
                    `  ‚Ä¢ ${key.replace('_', ' ')}: ${value}`
                ).join('\n');
                
                alert(details);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load seed data
        async function loadSeedData() {
            try {
                const response = await fetch('/seed_data', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadHouses();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Clear all houses
        async function clearAllHouses() {
            if (!confirm('Are you sure you want to delete all houses?')) return;
            
            try {
                const response = await fetch('/clear_all', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Clear localStorage as well
                    localStorage.removeItem(STORAGE_KEY);
                    console.log('Cleared localStorage');
                    loadHouses();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('addHouseForm').reset();
        }

        // Auto-update garage checkboxes
        document.getElementById('two_car_garage').addEventListener('change', (e) => {
            if (e.target.checked) {
                document.getElementById('has_garage').checked = true;
            }
        });

        document.getElementById('has_garage').addEventListener('change', (e) => {
            if (!e.target.checked) {
                document.getElementById('two_car_garage').checked = false;
            }
        });

        // Toggle HOA fee input visibility
        document.getElementById('has_hoa').addEventListener('change', (e) => {
            const feeContainer = document.getElementById('hoaFeeContainer');
            if (e.target.checked) {
                feeContainer.classList.remove('hidden');
            } else {
                feeContainer.classList.add('hidden');
                document.getElementById('hoa_monthly_fee').value = 0;
            }
        });

        // Load houses on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // First, sync any saved houses from localStorage to server
            await syncFromLocalStorage();
            // Then load and display all houses
            loadHouses();
        });
    </script>
</body>
</html>
