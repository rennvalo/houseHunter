<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HouseHunter - Find Your Dream Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=2000&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .score-positive {
            color: #10b981;
        }
        .score-negative {
            color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1"></div>
                <div class="flex-1 text-center">
                    <h1 class="text-5xl font-bold text-white drop-shadow-lg mb-2">üè† HouseHunter</h1>
                    <p class="text-xl text-white drop-shadow-md">Make Smart House Decisions with Data-Driven Scoring</p>
                </div>
                <div class="flex-1 flex justify-end">
                    <div id="userStatus" class="glass-effect rounded-lg px-4 py-2 text-sm">
                        <span id="userInfo" class="text-gray-700">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Auth Modal -->
        <div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="glass-effect rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Account Login</h2>
                    <button onclick="closeAuthModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="mb-4">
                    <div class="flex border-b border-gray-300">
                        <button id="loginTab" onclick="switchAuthTab('login')" class="flex-1 py-2 font-medium text-blue-600 border-b-2 border-blue-600">Login</button>
                        <button id="registerTab" onclick="switchAuthTab('register')" class="flex-1 py-2 font-medium text-gray-500">Register</button>
                    </div>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                        Login
                    </button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="space-y-4 hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                            <input type="text" id="registerFirstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                            <input type="text" id="registerLastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="registerEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="registerPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="(555) 123-4567">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="registerPassword" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                        <input type="password" id="registerPasswordConfirm" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition font-medium">
                        Create Account
                    </button>
                </form>

                <div class="mt-4 pt-4 border-t border-gray-300 text-sm text-gray-600">
                    <p><strong>Optional:</strong> Create an account to sync your houses across devices.</p>
                    <p class="mt-2">Without an account, your houses are stored locally on this browser.</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Add/Search House Form -->
            <div class="lg:col-span-1">
                <div class="glass-effect rounded-lg shadow-xl p-6">
                    <!-- Tab Navigation -->
                    <div class="mb-4">
                        <div class="flex border-b border-gray-300">
                            <button id="addHouseTab" onclick="switchFormTab('add')" 
                                class="flex-1 py-2 px-4 font-medium text-blue-600 border-b-2 border-blue-600 transition">
                                Add a House
                            </button>
                            <button id="searchHouseTab" onclick="switchFormTab('search')" 
                                class="flex-1 py-2 px-4 font-medium text-gray-500 hover:text-gray-700 transition">
                                Search Houses
                            </button>
                        </div>
                    </div>

                    <!-- Add House Section -->
                    <div id="addHouseSection">
                        <div class="flex items-center justify-between mb-4">
                            <h2 id="formTitle" class="text-2xl font-bold text-gray-800">Add a House</h2>
                            <button type="button" id="cancelEditBtn" onclick="cancelEdit()" 
                                class="hidden text-sm px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                                Cancel Edit
                            </button>
                        </div>
                    <form id="addHouseForm" class="space-y-4">
                        <input type="hidden" id="editHouseId" value="">
                        <!-- Address -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Address *</label>
                            <div class="flex gap-2">
                                <input type="text" id="address" required
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="123 Main Street, City">
                                <button type="button" id="autoFillBtn" onclick="autoPopulateFromAddress()" 
                                    class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 transition whitespace-nowrap disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    title="Auto-fill property details from address">
                                    üîç Auto-Fill
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" id="autoFillHint">Enter address and click Auto-Fill to populate property details automatically</p>
                        </div>

                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Notes</label>
                            <textarea id="notes" rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Any additional thoughts..."></textarea>
                        </div>

                        <!-- Photo Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Photo</label>
                            <input type="file" id="photo" accept="image/*"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <div id="photoPreview" class="mt-2 hidden">
                                <img id="photoPreviewImg" src="" alt="Preview" class="max-w-full h-32 rounded-md border border-gray-300">
                                <button type="button" onclick="clearPhoto()" class="mt-1 text-xs text-red-600 hover:text-red-800">Remove Photo</button>
                            </div>
                        </div>

                        <!-- Features -->
                        <div class="border-t pt-4">
                            <h3 class="font-semibold text-gray-800 mb-3">Features</h3>
                            
                            <!-- Garage -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Garage (# of cars) <span class="text-green-600">(+1 per car)</span>
                                </label>
                                <input type="number" id="garage_cars" min="0"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="0, 1, 2, 3, etc.">
                            </div>

                            <!-- Bedrooms -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Bedrooms <span class="text-green-600">(+1 per bedroom)</span>
                                </label>
                                <input type="number" id="bedrooms" min="0"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 3">
                            </div>

                            <!-- Bathrooms -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Bathrooms
                                </label>
                                <input type="number" id="bathrooms" min="0"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1 mt-2">
                                    Bathroom Quality <span class="text-xs text-gray-500">(multiplies count by: Normal +1, Modern +2, Needs Updates -1)</span>
                                </label>
                                <select id="bathroom_quality" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="normal">Normal (√ó1)</option>
                                    <option value="modern">Modern (√ó2)</option>
                                    <option value="needs_updates">Needs Updates (√ó-1)</option>
                                </select>
                            </div>

                            <!-- Square Feet -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Square Feet <span class="text-green-600">(+1 per 500 sq ft)</span>
                                </label>
                                <input type="number" id="square_feet" min="0"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 1200">
                            </div>

                            <!-- Lot Size -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Lot Size (acres) <span class="text-green-600">(+1 per 0.25 acres)</span>
                                </label>
                                <input type="number" id="lot_acres" min="0" step="0.01"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 0.5">
                            </div>

                            <!-- Other Features -->
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="nice_backyard" class="rounded">
                                    <span class="text-sm">Nice Backyard <span class="text-green-600">(+2)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="curb_appeal" class="rounded">
                                    <span class="text-sm">Curb Appeal <span class="text-green-600">(+1)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="has_deck" class="rounded">
                                    <span class="text-sm">Has Deck <span class="text-green-600">(+1)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="patio_potential" class="rounded">
                                    <span class="text-sm">Patio Potential <span class="text-green-600">(+2)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="has_pool" class="rounded">
                                    <span class="text-sm">Has Pool <span class="text-green-600">(+3)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="near_recreation" class="rounded">
                                    <span class="text-sm">Near Recreation Areas <span class="text-green-600">(+2)</span></span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="walking_shopping" class="rounded">
                                    <span class="text-sm">Walking Distance to Shopping <span class="text-green-600">(+2)</span></span>
                                </label>
                            </div>

                            <!-- Basement -->
                            <div class="mt-3 pt-3 border-t">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Basement</label>
                                <select id="basement" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="0">No Basement (+0)</option>
                                    <option value="1">Unfinished Basement (+1)</option>
                                    <option value="2">Finished Basement (+2)</option>
                                </select>
                            </div>

                            <!-- Privacy -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Privacy from Neighbors</label>
                                <select id="privacy" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="very_private">Very Private (+3)</option>
                                    <option value="private">Private (+2)</option>
                                    <option value="normal" selected>Normal (+1)</option>
                                    <option value="not_private">Not Private (-1)</option>
                                </select>
                            </div>

                            <!-- Noise Level -->
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Noise Level</label>
                                <select id="noise_level" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="quiet">Quiet (+1)</option>
                                    <option value="normal" selected>Normal (+0)</option>
                                    <option value="loud">Loud (-1)</option>
                                </select>
                            </div>

                            <!-- Appliances -->
                            <div class="mt-3 pt-3 border-t">
                                <h4 class="font-semibold text-gray-700 mb-2">
                                    Appliances <span class="text-xs text-gray-500">(Old: +1, Modern: +2, Missing: -2)</span>
                                </h4>
                                <div class="space-y-2" id="appliancesContainer">
                                    <!-- Dishwasher -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_dishwasher" class="rounded appliance-checkbox" data-appliance="dishwasher">
                                        <span class="text-sm w-24">Dishwasher</span>
                                        <select id="app_dishwasher_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                    <!-- Range -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_range" class="rounded appliance-checkbox" data-appliance="range">
                                        <span class="text-sm w-24">Range</span>
                                        <select id="app_range_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                    <!-- Oven -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_oven" class="rounded appliance-checkbox" data-appliance="oven">
                                        <span class="text-sm w-24">Oven</span>
                                        <select id="app_oven_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                    <!-- Fridge -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_fridge" class="rounded appliance-checkbox" data-appliance="fridge">
                                        <span class="text-sm w-24">Fridge</span>
                                        <select id="app_fridge_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                    <!-- Washer -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_washer" class="rounded appliance-checkbox" data-appliance="washer">
                                        <span class="text-sm w-24">Washer</span>
                                        <select id="app_washer_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                    <!-- Dryer -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_dryer" class="rounded appliance-checkbox" data-appliance="dryer">
                                        <span class="text-sm w-24">Dryer</span>
                                        <select id="app_dryer_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                    <!-- Microwave -->
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="app_microwave" class="rounded appliance-checkbox" data-appliance="microwave">
                                        <span class="text-sm w-24">Microwave</span>
                                        <select id="app_microwave_age" class="text-sm px-2 py-1 border border-gray-300 rounded" disabled>
                                            <option value="old">Old (+1)</option>
                                            <option value="modern">Modern (+2)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- HOA -->
                            <div class="mt-3 pt-3 border-t">
                                <label class="flex items-center space-x-2 mb-2">
                                    <input type="checkbox" id="has_hoa" class="rounded">
                                    <span class="text-sm">Has HOA <span class="text-red-600">(-1 base, -1 per $100/mo)</span></span>
                                </label>
                                <div id="hoaFeeContainer" class="ml-6 hidden">
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Monthly HOA Fee ($)</label>
                                    <input type="number" id="hoa_monthly_fee" min="0"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex gap-2 pt-4">
                            <button type="submit" id="submitBtn"
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition font-semibold">
                                Add House
                            </button>
                            <button type="button" onclick="resetForm()"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">
                                Clear
                            </button>
                        </div>
                    </form>

                        <!-- Quick Actions -->
                        <div class="mt-6 pt-4 border-t space-y-2">
                            <button onclick="loadSeedData()" 
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition text-sm">
                                Load Example Houses
                            </button>
                            <button onclick="clearAllHouses()" 
                                class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition text-sm">
                                Clear All Houses
                            </button>
                        </div>
                    </div>
                    <!-- End Add House Section -->

                    <!-- Search House Section -->
                    <div id="searchHouseSection" class="hidden">
                        <div class="mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Search Houses</h2>
                            <p class="text-sm text-gray-600 mt-1">Find properties in a ZIP code within your budget</p>
                        </div>

                        <!-- Login Required Notice -->
                        <div id="searchLoginNotice" class="hidden mb-4 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                üîí <strong>Login Required:</strong> This feature is only available to registered users.
                                <button onclick="showAuthModal()" class="text-blue-600 hover:text-blue-800 font-medium underline ml-1">Login or Create Account</button>
                            </p>
                        </div>

                        <!-- Search Form -->
                        <form id="searchHouseForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">ZIP Code *</label>
                                <input type="text" id="searchZipCode" required pattern="\d{5}" maxlength="5"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="80303">
                                <p class="text-xs text-gray-500 mt-1">Enter 5-digit ZIP code</p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Maximum Price *</label>
                                <input type="number" id="searchMaxPrice" required min="0" step="1000"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="700000">
                                <p class="text-xs text-gray-500 mt-1">Properties at or below this price</p>
                            </div>

                            <button type="submit" id="searchSubmitBtn"
                                class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition font-semibold">
                                üîç Search Properties
                            </button>
                        </form>

                        <!-- Search Results -->
                        <div id="searchResultsContainer" class="mt-6 hidden">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-gray-800">Search Results</h3>
                                <span id="searchResultsCount" class="text-sm text-gray-600">0 properties</span>
                            </div>
                            <div id="searchResultsList" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                    <!-- End Search House Section -->
                </div>
            </div>

            <!-- Houses List -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-lg shadow-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Your Houses</h2>
                        <span id="houseCount" class="text-sm text-gray-600">0 houses</span>
                    </div>
                    
                    <div id="housesContainer" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No houses added yet. Start by adding your first house!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // User identification - UUID stored in localStorage
        const USER_ID_KEY = 'househunter_user_id';
        const USER_AUTH_KEY = 'househunter_auth_user';
        
        // Store current photo data globally to prevent loss during form operations
        let currentPhotoData = null;
        let currentPrice = null;  // Store price from auto-fill
        
        // Get or create user ID
        function getUserId() {
            // Check if logged in with account
            const authUser = localStorage.getItem(USER_AUTH_KEY);
            if (authUser) {
                const user = JSON.parse(authUser);
                return `user_${user.id}`; // Use account ID
            }
            
            // Otherwise use anonymous UUID
            let userId = localStorage.getItem(USER_ID_KEY);
            if (!userId) {
                // Generate new UUID
                userId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                localStorage.setItem(USER_ID_KEY, userId);
                console.log('Generated new user ID:', userId);
            }
            return userId;
        }
        
        // Helper function to add auth headers to fetch requests
        function getHeaders(additionalHeaders = {}) {
            return {
                'X-User-ID': getUserId(),
                ...additionalHeaders
            };
        }
        
        // LocalStorage key for houses
        const STORAGE_KEY = 'househunter_houses';

        // Save houses to localStorage
        function saveToLocalStorage(houses) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(houses));
                console.log('Saved to localStorage:', houses.length, 'houses');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // Load houses from localStorage
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return [];
            }
        }

        // Sync houses from localStorage to server on startup
        async function syncFromLocalStorage() {
            // First check if server already has data
            try {
                const serverResponse = await fetch('/houses', {
                    headers: getHeaders()
                });
                const serverHouses = await serverResponse.json();
                
                if (serverHouses.length > 0) {
                    // Server has data - it's the source of truth
                    console.log('Server has', serverHouses.length, 'houses. Skipping localStorage sync.');
                    // Clear localStorage to prevent future sync attempts
                    localStorage.removeItem(STORAGE_KEY);
                    return;
                }
                
                // Only sync from localStorage if server is empty
                const localHouses = loadFromLocalStorage();
                
                if (localHouses.length > 0) {
                    console.log('Server is empty. Syncing', localHouses.length, 'houses from localStorage...');
                    const response = await fetch('/sync_houses', {
                        method: 'POST',
                        headers: getHeaders({
                            'Content-Type': 'application/json',
                        }),
                        body: JSON.stringify(localHouses)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Sync successful:', result.message);
                        // Clear localStorage after successful sync
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            } catch (error) {
                console.error('Error syncing from localStorage:', error);
            }
        }

        // Form submission
        document.getElementById('addHouseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Collect appliances data
            const appliances = {};
            document.querySelectorAll('.appliance-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    const applianceName = checkbox.dataset.appliance;
                    const ageSelect = document.getElementById(`app_${applianceName}_age`);
                    appliances[applianceName] = ageSelect.value;
                }
            });
            
            // Handle photo upload
            let photoData = null;
            const photoInput = document.getElementById('photo');
            
            // Check if auto-fill loaded a photo URL
            if (photoInput.dataset.photoUrl) {
                // Convert URL to base64
                try {
                    const urlPhotoResponse = await fetch(photoInput.dataset.photoUrl);
                    const blob = await urlPhotoResponse.blob();
                    photoData = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(blob);
                    });
                    currentPhotoData = photoData;
                    // Clear the URL so we don't re-download on next submit
                    delete photoInput.dataset.photoUrl;
                } catch (error) {
                    console.error('Error loading photo from URL:', error);
                    // Continue without photo if URL fetch fails
                }
            } else if (photoInput.files && photoInput.files[0]) {
                // New file selected
                const reader = new FileReader();
                photoData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(photoInput.files[0]);
                });
                currentPhotoData = photoData; // Store globally
            } else if (currentPhotoData) {
                // Keep existing photo if in edit mode or if already loaded
                photoData = currentPhotoData;
            }
            
            const houseData = {
                address: document.getElementById('address').value,
                notes: document.getElementById('notes').value || null,
                photo: photoData,
                price: currentPrice,  // Include price from auto-fill
                features: {
                    garage_cars: parseInt(document.getElementById('garage_cars').value) || 0,
                    bathrooms: parseInt(document.getElementById('bathrooms').value),
                    bathroom_quality: document.getElementById('bathroom_quality').value,
                    bedrooms: parseInt(document.getElementById('bedrooms').value),
                    square_feet: parseInt(document.getElementById('square_feet').value) || 0,
                    lot_acres: parseFloat(document.getElementById('lot_acres').value) || 0,
                    nice_backyard: document.getElementById('nice_backyard').checked,
                    curb_appeal: document.getElementById('curb_appeal').checked,
                    appliances: appliances,
                    basement: parseInt(document.getElementById('basement').value) || 0,
                    privacy: document.getElementById('privacy').value,
                    noise_level: document.getElementById('noise_level').value,
                    has_deck: document.getElementById('has_deck').checked,
                    patio_potential: document.getElementById('patio_potential').checked,
                    has_pool: document.getElementById('has_pool').checked,
                    near_recreation: document.getElementById('near_recreation').checked,
                    walking_shopping: document.getElementById('walking_shopping').checked,
                    has_hoa: document.getElementById('has_hoa').checked,
                    hoa_monthly_fee: parseInt(document.getElementById('hoa_monthly_fee').value) || 0
                }
            };
            
            // Debug: Log if photo is included
            console.log('Submitting house with photo:', photoData ? 'Yes (' + photoData.substring(0, 50) + '...)' : 'No');

            try {
                const editHouseId = document.getElementById('editHouseId').value;
                let response;
                
                if (editHouseId) {
                    // Update existing house
                    response = await fetch(`/house/${editHouseId}`, {
                        method: 'PUT',
                        headers: getHeaders({
                            'Content-Type': 'application/json',
                        }),
                        body: JSON.stringify(houseData)
                    });
                } else {
                    // Add new house
                    response = await fetch('/add_house', {
                        method: 'POST',
                        headers: getHeaders({
                            'Content-Type': 'application/json',
                        }),
                        body: JSON.stringify(houseData)
                    });
                }

                if (response.ok) {
                    resetForm();
                    loadHouses();
                } else {
                    alert('Error saving house');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving house');
            }
        });

        // Load all houses
        async function loadHouses() {
            try {
                const response = await fetch('/houses', {
                    headers: getHeaders()
                });
                const houses = await response.json();
                
                // Save to localStorage whenever we load houses
                saveToLocalStorage(houses);
                
                const container = document.getElementById('housesContainer');
                const countEl = document.getElementById('houseCount');
                
                countEl.textContent = `${houses.length} house${houses.length !== 1 ? 's' : ''}`;
                
                if (houses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No houses added yet. Start by adding your first house!</p>';
                    return;
                }
                
                container.innerHTML = houses.map(house => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                        <div class="flex gap-4 items-start mb-2">
                            ${house.photo ? `
                                <div class="flex-shrink-0">
                                    <img src="${house.photo}" alt="${house.address}" class="w-32 h-32 object-cover rounded-md border border-gray-300">
                                </div>
                            ` : ''}
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">${house.address}</h3>
                                ${house.price ? `<p class="text-sm text-green-600 font-semibold mt-1">$${house.price.toLocaleString()}</p>` : ''}
                                ${house.notes ? `<p class="text-sm text-gray-600 mt-1">${house.notes}</p>` : ''}
                            </div>
                            <div class="text-right ml-4 flex-shrink-0">
                                <div class="text-3xl font-bold ${house.score >= 0 ? 'score-positive' : 'score-negative'}">
                                    ${house.score >= 0 ? '+' : ''}${house.score}
                                </div>
                                <div class="text-xs text-gray-500">points</div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${Object.entries(house.score_breakdown).map(([key, value]) => `
                                    <div class="text-gray-700">
                                        <span class="font-medium">${key.replace('_', ' ')}:</span> ${value}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200 flex gap-2">
                            <button onclick="viewDetails(${house.id})" 
                                class="flex-1 bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 transition">
                                View Details
                            </button>
                            <button onclick="editHouse(${house.id})" 
                                class="flex-1 bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200 transition">
                                Edit
                            </button>
                            <button onclick="deleteHouse(${house.id})" 
                                class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200 transition">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading houses:', error);
            }
        }

        // Delete house
        async function deleteHouse(id) {
            if (!confirm('Are you sure you want to delete this house?')) return;
            
            try {
                const response = await fetch(`/house/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    loadHouses();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Edit house
        async function editHouse(id) {
            try {
                const response = await fetch(`/house/${id}`, {
                    headers: getHeaders()
                });
                const house = await response.json();
                
                // Populate form with house data
                document.getElementById('editHouseId').value = house.id;
                document.getElementById('address').value = house.address;
                document.getElementById('notes').value = house.notes || '';
                
                // Load photo if exists
                if (house.photo) {
                    document.getElementById('photoPreviewImg').src = house.photo;
                    document.getElementById('photoPreview').classList.remove('hidden');
                    currentPhotoData = house.photo; // Store in global variable
                } else {
                    clearPhoto();
                }
                
                // Populate features
                document.getElementById('garage_cars').value = house.features.garage_cars || 0;
                document.getElementById('bathrooms').value = house.features.bathrooms;
                document.getElementById('bathroom_quality').value = house.features.bathroom_quality || 'normal';
                document.getElementById('bedrooms').value = house.features.bedrooms;
                document.getElementById('square_feet').value = house.features.square_feet || 0;
                document.getElementById('lot_acres').value = house.features.lot_acres || 0;
                document.getElementById('nice_backyard').checked = house.features.nice_backyard;
                document.getElementById('curb_appeal').checked = house.features.curb_appeal;
                document.getElementById('basement').value = house.features.basement || 0;
                document.getElementById('privacy').value = house.features.privacy || 'normal';
                document.getElementById('noise_level').value = house.features.noise_level || 'normal';
                document.getElementById('has_deck').checked = house.features.has_deck || false;
                document.getElementById('patio_potential').checked = house.features.patio_potential || false;
                document.getElementById('has_pool').checked = house.features.has_pool || false;
                document.getElementById('near_recreation').checked = house.features.near_recreation || false;
                document.getElementById('walking_shopping').checked = house.features.walking_shopping || false;
                document.getElementById('has_hoa').checked = house.features.has_hoa;
                document.getElementById('hoa_monthly_fee').value = house.features.hoa_monthly_fee || 0;
                
                // Show/hide HOA fee container
                const feeContainer = document.getElementById('hoaFeeContainer');
                if (house.features.has_hoa) {
                    feeContainer.classList.remove('hidden');
                } else {
                    feeContainer.classList.add('hidden');
                }
                
                // Populate appliances
                // First, uncheck all appliances
                document.querySelectorAll('.appliance-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    const applianceName = checkbox.dataset.appliance;
                    const ageSelect = document.getElementById(`app_${applianceName}_age`);
                    ageSelect.disabled = true;
                    ageSelect.value = 'old';
                });
                
                // Then check and set the ones from the house
                if (house.features.appliances) {
                    Object.entries(house.features.appliances).forEach(([appliance, condition]) => {
                        const checkbox = document.getElementById(`app_${appliance}`);
                        const ageSelect = document.getElementById(`app_${appliance}_age`);
                        if (checkbox) {
                            checkbox.checked = true;
                            ageSelect.disabled = false;
                            ageSelect.value = condition;
                        }
                    });
                }
                
                // Update UI for edit mode
                document.getElementById('formTitle').textContent = 'Edit House';
                document.getElementById('submitBtn').textContent = 'Update House';
                document.getElementById('cancelEditBtn').classList.remove('hidden');
                
                // Scroll to form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading house for editing');
            }
        }

        // Cancel edit mode
        function cancelEdit() {
            resetForm();
        }

        // Auto-populate property details from address using RapidAPI
        async function autoPopulateFromAddress() {
            // Check if user is logged in
            const authUser = localStorage.getItem(USER_AUTH_KEY);
            if (!authUser) {
                alert('Auto-Fill feature is only available for logged-in users. Please login or create an account to use this feature.');
                return;
            }
            
            const addressInput = document.getElementById('address');
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter an address first');
                addressInput.focus();
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Loading...';
            button.disabled = true;
            
            try {
                const response = await fetch(`/lookup_address?address=${encodeURIComponent(address)}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to lookup address');
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    // Auto-fill the form fields
                    if (data.address) {
                        document.getElementById('address').value = data.address;
                    }
                    if (data.bedrooms !== undefined && data.bedrooms !== null) {
                        document.getElementById('bedrooms').value = data.bedrooms;
                    }
                    if (data.bathrooms !== undefined && data.bathrooms !== null) {
                        document.getElementById('bathrooms').value = Math.floor(data.bathrooms);
                    }
                    if (data.square_feet !== undefined && data.square_feet !== null) {
                        document.getElementById('square_feet').value = data.square_feet;
                    }
                    if (data.lot_acres !== undefined && data.lot_acres !== null) {
                        document.getElementById('lot_acres').value = data.lot_acres;
                    }
                    if (data.garage_cars !== undefined && data.garage_cars !== null) {
                        document.getElementById('garage_cars').value = data.garage_cars;
                    }
                    
                    // Store price if available
                    if (data.price !== undefined && data.price !== null) {
                        currentPrice = data.price;
                    }
                    
                    // Auto-fill photo if available
                    if (data.photo_url) {
                        const photoInput = document.getElementById('photo');
                        const photoPreviewImg = document.getElementById('photoPreviewImg');
                        const photoPreview = document.getElementById('photoPreview');
                        
                        // Set the URL in the input (it will be converted to base64 on form submit)
                        photoInput.dataset.photoUrl = data.photo_url;
                        
                        // Show preview
                        if (photoPreviewImg && photoPreview) {
                            photoPreviewImg.src = data.photo_url;
                            photoPreview.classList.remove('hidden');
                        }
                    }
                    
                    // Show success message
                    alert(`‚úÖ Property details loaded successfully!\\n\\nBedrooms: ${data.bedrooms}\\nBathrooms: ${data.bathrooms}\\nSquare Feet: ${data.square_feet}\\nLot Size: ${data.lot_acres} acres\\nGarage: ${data.garage_cars} cars${data.price ? '\\nPrice: $' + data.price.toLocaleString() : ''}${data.photo_url ? '\\nPhoto: Loaded' : ''}\\n\\nPlease review and fill in remaining details.`);
                } else {
                    throw new Error('No data returned from API');
                }
                
            } catch (error) {
                console.error('Error:', error);
                console.error('Full error details:', error.message);
                let errorMessage = 'Failed to auto-fill property details.\\n\\n';
                
                // Show the actual error message from the API
                errorMessage += error.message;
                
                alert(errorMessage);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // View details
        async function viewDetails(id) {
            try {
                const response = await fetch(`/score/${id}`, {
                    headers: getHeaders()
                });
                const data = await response.json();
                
                let details = `üìç ${data.address}\n\n`;
                details += `Total Score: ${data.score >= 0 ? '+' : ''}${data.score}\n\n`;
                details += 'Breakdown:\n';
                details += Object.entries(data.breakdown).map(([key, value]) => 
                    `  ‚Ä¢ ${key.replace('_', ' ')}: ${value}`
                ).join('\n');
                
                alert(details);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load seed data
        async function loadSeedData() {
            try {
                const response = await fetch('/seed_data', {
                    method: 'POST',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    loadHouses();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Clear all houses
        async function clearAllHouses() {
            if (!confirm('Are you sure you want to delete all houses?')) return;
            
            try {
                const response = await fetch('/clear_all', {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    // Clear localStorage as well
                    localStorage.removeItem(STORAGE_KEY);
                    console.log('Cleared localStorage');
                    loadHouses();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('addHouseForm').reset();
            document.getElementById('editHouseId').value = '';
            
            // Reset UI to add mode
            document.getElementById('formTitle').textContent = 'Add a House';
            document.getElementById('submitBtn').textContent = 'Add House';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            
            // Reset appliance selects
            document.querySelectorAll('.appliance-checkbox').forEach(checkbox => {
                const applianceName = checkbox.dataset.appliance;
                const ageSelect = document.getElementById(`app_${applianceName}_age`);
                ageSelect.disabled = true;
            });
            
            // Clear photo preview
            clearPhoto();
        }

        // Photo handling functions
        function clearPhoto() {
            document.getElementById('photo').value = '';
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoPreviewImg').src = '';
            currentPhotoData = null; // Clear global photo data
        }

        // Photo preview on file selection
        document.getElementById('photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoDataUrl = e.target.result;
                    document.getElementById('photoPreviewImg').src = photoDataUrl;
                    document.getElementById('photoPreview').classList.remove('hidden');
                    currentPhotoData = photoDataUrl; // Store in global variable
                };
                reader.readAsDataURL(file);
            }
        });

        // Toggle HOA fee input visibility
        document.getElementById('has_hoa').addEventListener('change', (e) => {
            const feeContainer = document.getElementById('hoaFeeContainer');
            if (e.target.checked) {
                feeContainer.classList.remove('hidden');
            } else {
                feeContainer.classList.add('hidden');
                document.getElementById('hoa_monthly_fee').value = 0;
            }
        });

        // Handle appliance checkbox changes
        document.querySelectorAll('.appliance-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const applianceName = e.target.dataset.appliance;
                const ageSelect = document.getElementById(`app_${applianceName}_age`);
                ageSelect.disabled = !e.target.checked;
                if (!e.target.checked) {
                    ageSelect.value = 'old'; // Reset to default
                }
            });
        });

        // Auth Modal Functions
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                registerTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                loginTab.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        function updateUserStatus() {
            const authUser = localStorage.getItem(USER_AUTH_KEY);
            const userInfo = document.getElementById('userInfo');
            const userStatus = document.getElementById('userStatus');
            const autoFillBtn = document.getElementById('autoFillBtn');
            const autoFillHint = document.getElementById('autoFillHint');

            if (authUser) {
                const user = JSON.parse(authUser);
                userInfo.innerHTML = `
                    <span class="font-medium">${user.first_name} ${user.last_name}</span>
                    <button onclick="logout()" class="ml-2 text-red-600 hover:text-red-800 font-medium">Logout</button>
                `;
                // Enable Auto-Fill for logged-in users
                if (autoFillBtn) {
                    autoFillBtn.disabled = false;
                    autoFillBtn.title = 'Auto-fill property details from address';
                }
                if (autoFillHint) {
                    autoFillHint.textContent = 'Enter address and click Auto-Fill to populate property details automatically';
                    autoFillHint.classList.remove('text-orange-600');
                    autoFillHint.classList.add('text-gray-500');
                }
            } else {
                const userId = getUserId();
                userInfo.innerHTML = `
                    <span>Anonymous User</span>
                    <button onclick="showAuthModal()" class="ml-2 text-blue-600 hover:text-blue-800 font-medium">Login</button>
                `;
                // Disable Auto-Fill for anonymous users
                if (autoFillBtn) {
                    autoFillBtn.disabled = true;
                    autoFillBtn.title = 'Login required to use Auto-Fill feature';
                }
                if (autoFillHint) {
                    autoFillHint.textContent = 'üîí Auto-Fill requires login - Login to automatically populate property details';
                    autoFillHint.classList.remove('text-gray-500');
                    autoFillHint.classList.add('text-orange-600');
                }
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout? Your houses will remain saved.')) {
                localStorage.removeItem(USER_AUTH_KEY);
                updateUserStatus();
                // Reload houses for anonymous user
                loadHouses();
            }
        }

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const user = await response.json();
                    localStorage.setItem(USER_AUTH_KEY, JSON.stringify(user));
                    updateUserStatus();
                    closeAuthModal();
                    
                    // Reload houses for logged-in user
                    loadHouses();
                    alert('Successfully logged in!');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        });

        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                alert('Passwords do not match');
                return;
            }

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        first_name: firstName,
                        last_name: lastName,
                        email: email,
                        phone: phone,
                        password: password
                    })
                });

                if (response.ok) {
                    const user = await response.json();
                    localStorage.setItem(USER_AUTH_KEY, JSON.stringify(user));
                    updateUserStatus();
                    closeAuthModal();
                    
                    // Reload houses for new user
                    loadHouses();
                    alert('Account created successfully!');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Registration failed');
                }
            } catch (error) {
                console.error('Register error:', error);
                alert('Registration failed. Please try again.');
            }
        });

        // Tab switching for Add/Search House
        function switchFormTab(tab) {
            const addTab = document.getElementById('addHouseTab');
            const searchTab = document.getElementById('searchHouseTab');
            const addSection = document.getElementById('addHouseSection');
            const searchSection = document.getElementById('searchHouseSection');
            const searchLoginNotice = document.getElementById('searchLoginNotice');

            if (tab === 'add') {
                // Switch to Add House tab
                addTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                addTab.classList.remove('text-gray-500');
                searchTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                searchTab.classList.add('text-gray-500');
                addSection.classList.remove('hidden');
                searchSection.classList.add('hidden');
            } else if (tab === 'search') {
                // Switch to Search House tab
                searchTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                searchTab.classList.remove('text-gray-500');
                addTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                addTab.classList.add('text-gray-500');
                searchSection.classList.remove('hidden');
                addSection.classList.add('hidden');

                // Check if user is logged in
                const authUser = localStorage.getItem(USER_AUTH_KEY);
                if (!authUser) {
                    searchLoginNotice.classList.remove('hidden');
                    document.getElementById('searchHouseForm').classList.add('hidden');
                } else {
                    searchLoginNotice.classList.add('hidden');
                    document.getElementById('searchHouseForm').classList.remove('hidden');
                }
            }
        }

        // Search house form submission
        document.getElementById('searchHouseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const zipCode = document.getElementById('searchZipCode').value.trim();
            const maxPrice = parseInt(document.getElementById('searchMaxPrice').value);
            
            // Verify user is logged in
            const authUser = localStorage.getItem(USER_AUTH_KEY);
            if (!authUser) {
                alert('This feature is only available to registered users. Please login or create an account.');
                showAuthModal();
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('searchSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Searching...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`/search_properties?zip_code=${zipCode}&max_price=${maxPrice}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Search failed');
                }
                
                const result = await response.json();
                
                if (result.success && result.properties && result.properties.length > 0) {
                    displaySearchResults(result.properties, zipCode, maxPrice);
                } else {
                    alert(`No properties found in ZIP code ${zipCode} for $${maxPrice.toLocaleString()} or less.\\n\\nTry a different ZIP code or higher price.`);
                    document.getElementById('searchResultsContainer').classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                alert(`Search failed: ${error.message}`);
                document.getElementById('searchResultsContainer').classList.add('hidden');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Display search results
        function displaySearchResults(properties, zipCode, maxPrice) {
            const container = document.getElementById('searchResultsContainer');
            const list = document.getElementById('searchResultsList');
            const count = document.getElementById('searchResultsCount');
            
            count.textContent = `${properties.length} ${properties.length === 1 ? 'property' : 'properties'} found`;
            
            list.innerHTML = properties.map(prop => `
                <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition bg-white">
                    <div class="flex gap-3 items-start">
                        ${prop.photo_url ? `
                            <div class="flex-shrink-0">
                                <img src="${prop.photo_url}" alt="${prop.address}" class="w-20 h-20 object-cover rounded border border-gray-300">
                            </div>
                        ` : ''}
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-sm text-gray-800 truncate">${prop.address}</h4>
                            <p class="text-lg font-bold text-green-600">$${prop.price.toLocaleString()}</p>
                            <div class="text-xs text-gray-600 mt-1">
                                ${prop.bedrooms} bed ‚Ä¢ ${prop.bathrooms} bath ‚Ä¢ ${prop.square_feet.toLocaleString()} sqft
                                ${prop.garage_cars > 0 ? ` ‚Ä¢ ${prop.garage_cars} car garage` : ''}
                            </div>
                        </div>
                    </div>
                    <button onclick='addSearchResultToHouses(${JSON.stringify(prop).replace(/'/g, "&apos;")})' 
                        class="w-full mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition">
                        + Add to My Houses
                    </button>
                </div>
            `).join('');
            
            container.classList.remove('hidden');
        }

        // Add a search result property to user's houses
        async function addSearchResultToHouses(property) {
            // Verify user is logged in
            const authUser = localStorage.getItem(USER_AUTH_KEY);
            if (!authUser) {
                alert('Please login to add houses to your list.');
                return;
            }
            
            try {
                // Convert photo URL to base64 if available
                let photoData = null;
                if (property.photo_url) {
                    try {
                        const photoResponse = await fetch(property.photo_url);
                        const blob = await photoResponse.blob();
                        photoData = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(blob);
                        });
                    } catch (error) {
                        console.error('Error loading photo:', error);
                    }
                }
                
                // Create house data with basic features
                const houseData = {
                    address: property.address,
                    notes: `Found via search - ${property.property_type || 'Property'}`,
                    photo: photoData,
                    price: property.price,
                    features: {
                        garage_cars: property.garage_cars || 0,
                        bathrooms: Math.floor(property.bathrooms) || 0,
                        bathroom_quality: 'normal',
                        bedrooms: property.bedrooms || 0,
                        square_feet: property.square_feet || 0,
                        lot_acres: property.lot_acres || 0,
                        nice_backyard: false,
                        curb_appeal: false,
                        appliances: {},
                        basement: 0,
                        privacy: 'normal',
                        noise_level: 'normal',
                        has_deck: false,
                        patio_potential: false,
                        has_pool: false,
                        near_recreation: false,
                        walking_shopping: false,
                        has_hoa: false,
                        hoa_monthly_fee: 0
                    }
                };
                
                // Add to database
                const response = await fetch('/add_house', {
                    method: 'POST',
                    headers: getHeaders({
                        'Content-Type': 'application/json',
                    }),
                    body: JSON.stringify(houseData)
                });
                
                if (response.ok) {
                    // Reload houses list
                    loadHouses();
                    
                    // Switch back to Add House tab so user can see it was added
                    switchFormTab('add');
                    
                    // Show success message
                    alert(`‚úÖ Property added to your list!\\n\\nYou can now edit it to add more features and improve the score.`);
                } else {
                    alert('Error adding property to your list');
                }
            } catch (error) {
                console.error('Error adding search result:', error);
                alert('Error adding property to your list');
            }
        }

        // Load houses on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Update user status display
            updateUserStatus();
            
            // First, sync any saved houses from localStorage to server
            await syncFromLocalStorage();
            
            // Then load and display all houses
            loadHouses();
        });
    </script>

    <!-- Footer -->
    <footer class="mt-12 mb-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="glass-effect rounded-lg shadow-xl p-4">
                <div class="text-center text-sm text-gray-700">
                    <p class="mb-2">&copy; 2025 HouseHunter. All rights reserved.</p>
                    <p>
                        <a href="/privacy" class="text-blue-600 hover:text-blue-800 font-medium underline">Privacy Policy</a>
                        <span class="mx-2">|</span>
                        <a href="/terms" class="text-blue-600 hover:text-blue-800 font-medium underline">Terms of Use</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
